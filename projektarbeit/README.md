# Projektarbeit - Automated reportbased CSP Generation
The aim of this project is a tool for automated Content-Security-Policy generation for a certain website based on reports generated by browsers and/or testing tools - independent from the used server. 
To achieve this our tools consists of 3 (or 4) components: 
 1. A reverse proxy for the site which is used in the generation process
 2. A cgi/fcgi component for report collection
 3. Programs for report processing and policy generation
 4. Optional: A reverse proxy for the site which is acting as the frontend for the webservice instead of the actual site and which is using the generated policy

## Proxies
There are already multiple reverse proxies/webservers which fulfill our needs (adding headers to outgoing responses), namely:
 1. nginx
 2. apache http server

Unluckily some dedicated proxies like tinyproxy do NOT have the needed functionalities but as we need basic webserver functionality for 2. anyway we focused on working with nginx for this project.

Nginx configurations can be found in the proxy-folder.

## Collection
CSP Reporting is simple POSTing of a JSON object for every violation to a URL specified in the policy. What needs to be done in collection is therefor 
 1. Taking in the violation reports
 2. Storing the reports / passing the reports to the generator

For this we use cgi/fcgi through php-cgi in bindaddress-mode or php-fpm in combination with nginx (or any other webserver).

The needed php-scripts aswell as nginx/fpm configurations can be found in the collector-folder.

## Generation
In generation collected reports are processed and an minimal, according policy is created.

Unluckily violation reports generated by different browsers differ substancially, so having one processor for all types of clients would be difficult. It could be achieved by analysis of the reports or by storing the UAS of the reporter.

We instead choose to focus on violation reports generated by Google Chrome, as it is one of the most used desktop browsers and features plugins like postman useful in web application testing.

The generator can be found in the generator-folder.

## Installation
  2. Build: `make build`
  3. Install: `sudo ./install.sh`

Please keep in mind that this will overwrite your previous nginx configuration.

Configuration can also be done after installation, but then you have to change the new copies of the configuration files.

You also should set `cgi.fix_pathinfo=0` in your `php.ini` (whereever it is located in your case, most likely `/etc/php/php.ini` or similar).

## Usage
 1. Start nginx: `systemctl start nginx.service` (depending on your system)
 2. Start php-fcgi: `php-fcgi`
 3. Run your tests on your clients Google Chrome using `IP:8080` as the address of the webservice (where `IP` is the proxies address).
 4. Generate a policy using `csprg_chrome`. This policy is also written to `/usr/share/csprg/csprg_collector.csp`.
 5. Run `csprg_apply` and restart nginx (`systemctl restart nginx.service`).

Before running a second test you might want to delete the old `/usr/share/csprg/csprg_collector.txt` as otherwise future policies might include remainders of old policies that aren't necessary anymore.

If step 4. fails you might have to relax the `eval` and `inline` configurations for generation or change parts of the site. In general `inline` and `eval` should be used as little as possible, especially for `script-src`.
